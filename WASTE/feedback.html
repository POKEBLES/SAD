<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feedback / Resident Concerns - Waste Analytics</title>
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="dashboard-header">
    <div class="header-logo">
      <img src="https://tse1.mm.bing.net/th/id/OIP.7FZwq6jY3y6N8DpbxpyIagHaHa?pid=Api&P=0&h=180" alt="Partner Logo" class="header-logo-img-alt">
      <h1>Manila Waste Analytics</h1>
    </div>
    <nav class="header-nav">
      <a href="index.html"><i class="fa-solid fa-chart-pie"></i> Dashboard</a>
      <a href="data-management.html"><i class="fa-solid fa-file-csv"></i> Data Management</a>
      <a href="forecasting.html"><i class="fa-solid fa-chart-line"></i> Forecasting</a>
      <a href="clustering.html"><i class="fa-solid fa-users-viewfinder"></i> Clustering</a>
      <a href="reports.html"><i class="fa-solid fa-file-lines"></i> Reports</a>
      <a href="feedback.html" class="active"><i class="fa-solid fa-bullhorn"></i> Feedback</a>
      <a href="admin-dashboard.html"><i class="fa-solid fa-shield"></i> Admin</a>
      <a href="user-management.html"><i class="fa-solid fa-users"></i> Users</a>
    </nav>
    <div class="header-profile">
      <i class="fa-solid fa-user-circle" id="user-profile-icon" style="cursor: pointer; transition: transform 0.2s;" title="Click to view profile"></i>
    </div>
  </header>

  <script>
    document.getElementById('user-profile-icon').addEventListener('click', function(){
      window.location.href = 'user-profile.html';
    });
  </script>

  <main class="dashboard-container">
    <h2 class="dashboard-title">Feedback & Resident Concerns</h2>

    <div class="dashboard-card" style="display:grid;grid-template-columns:1fr 420px;gap:16px;align-items:start">
      <div>
        <h3>Submit a Concern</h3>
        <form id="feedback-form" class="form-grid" autocomplete="off">
          <label>
            Name
            <input id="fb-name" type="text" placeholder="Your name">
          </label>
          <label>
            Barangay
            <select id="fb-barangay">
              <option value="">-- Select --</option>
              <option>Barangay 1</option>
              <option>Barangay 2</option>
              <option>Barangay 3</option>
              <option>Barangay 4</option>
            </select>
          </label>
          <label>
            Concern Type
            <select id="fb-type">
              <option>Collection</option>
              <option>Segregation</option>
              <option>Illegal Dumping</option>
              <option>Other</option>
            </select>
          </label>
          <label style="grid-column:1/-1">
            Message
            <textarea id="fb-message" rows="5" placeholder="Describe the issue"></textarea>
          </label>
          <div class="form-actions" style="grid-column:1/-1">
            <button type="button" id="fb-submit" class="btn btn-primary">Submit</button>
            <button type="reset" class="btn">Reset</button>
          </div>
        </form>

        <div style="margin-top:18px">
          <h3>Recent Concerns</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <button id="export-csv" class="btn">Export CSV</button>
            <button id="print-concerns" class="btn">Print</button>
          </div>
          <div class="table-wrap">
            <table id="concerns-table">
              <thead>
                <tr><th>Concern</th><th>Barangay</th><th>Date</th><th>Status</th><th>Response</th><th>Actions</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <aside>
        <div class="dashboard-card">
          <h3>Sentiment Summary</h3>
          <canvas id="sentimentChart" height="220"></canvas>
        </div>

        <div class="dashboard-card" style="margin-top:12px">
          <h3>Quick Stats</h3>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div>Total concerns: <strong id="stat-total">0</strong></div>
            <div>Open: <strong id="stat-open">0</strong></div>
            <div>Closed: <strong id="stat-closed">0</strong></div>
          </div>
        </div>
      </aside>
    </div>

  </main>

  <script>
  (function(){
    // load/save from localStorage
    function loadConcerns(){
      try{ const raw = localStorage.getItem('concerns_v1'); if(!raw) return null; return JSON.parse(raw); }catch(e){ return null; }
    }
    function saveConcerns(){ try{ localStorage.setItem('concerns_v1', JSON.stringify(concerns)); }catch(e){ console.error('save failed',e); } }

    // demo concerns dataset (used if no saved data)
    let concerns = loadConcerns() || [
      {msg:'Missed collection on Monday', barangay:'Barangay 1', date:'2025-11-10', status:'Open', response:'', sentiment:'negative'},
      {msg:'Segregation program is helpful', barangay:'Barangay 2', date:'2025-11-09', status:'Closed', response:'Thank you!', sentiment:'positive'},
      {msg:'Illegal dumping near market', barangay:'Barangay 3', date:'2025-11-08', status:'Open', response:'', sentiment:'negative'}
    ];

    const tbody = document.querySelector('#concerns-table tbody');
    const fName = document.getElementById('fb-name');
    const fBarangay = document.getElementById('fb-barangay');
    const fType = document.getElementById('fb-type');
    const fMessage = document.getElementById('fb-message');
    const submitBtn = document.getElementById('fb-submit');

    // Chart
    const ctx = document.getElementById('sentimentChart').getContext('2d');
    const chart = new Chart(ctx, {type:'pie', data:{labels:['Positive','Neutral','Negative'], datasets:[{data:[0,0,0], backgroundColor:['#84994F','#FFE797','#A72703']} ]}, options:{plugins:{legend:{position:'bottom'}}}});

    function renderTable(){
      tbody.innerHTML = '';
      concerns.slice().reverse().forEach((c, idx)=>{
        const tr = document.createElement('tr');
        // show newest first, compute real index
        const realIdx = concerns.length - 1 - idx;
        tr.innerHTML = `<td>${escapeHtml(c.msg)}</td><td>${escapeHtml(c.barangay)}</td><td>${escapeHtml(c.date)}</td><td>${escapeHtml(c.status)}</td><td>${escapeHtml(c.response||'')}</td><td style="white-space:nowrap"><button class="btn btn-small" data-action="respond" data-index="${realIdx}">Respond</button> <button class="btn btn-small" data-action="close" data-index="${realIdx}">Close</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function updateStats(){
      const total = concerns.length;
      const open = concerns.filter(c=>c.status==='Open').length;
      const closed = concerns.filter(c=>c.status==='Closed').length;
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-open').textContent = open;
      document.getElementById('stat-closed').textContent = closed;

      const pos = concerns.filter(c=>c.sentiment==='positive').length;
      const neu = concerns.filter(c=>c.sentiment==='neutral').length;
      const neg = concerns.filter(c=>c.sentiment==='negative').length;
      chart.data.datasets[0].data = [pos, neu, neg];
      chart.update();
    }

    function inferSentiment(text){
      const s = (text||'').toLowerCase();
      if(/thank|thanks|helpful|good|appreciate/.test(s)) return 'positive';
      if(/miss|not|late|missed|problem|illegal|dumping|complain|bad/.test(s)) return 'negative';
      return 'neutral';
    }

    submitBtn.addEventListener('click', function(){
      const msg = fMessage.value.trim();
      const barangay = fBarangay.value || 'Unknown';
      if(!msg){ alert('Please enter a message.'); return; }
      const today = new Date().toISOString().slice(0,10);
      const sentiment = inferSentiment(msg);
      concerns.push({msg, barangay, date:today, status:'Open', response:'', sentiment});
      fMessage.value=''; fName.value=''; fBarangay.value=''; fType.value='Collection';
      saveConcerns(); renderTable(); updateStats();
      // simple UX: notify user
      alert('Thank you â€” your concern was submitted.');
    });

    // handle respond/close actions via event delegation
    tbody.addEventListener('click', function(ev){
      const btn = ev.target.closest('button'); if(!btn) return;
      const action = btn.dataset.action; const idx = Number(btn.dataset.index);
      if(action==='respond'){
        const current = concerns[idx];
        const resp = prompt('Enter response to resident:', current.response || '');
        if(resp!==null){ current.response = resp; current.status = 'Closed'; saveConcerns(); renderTable(); updateStats(); }
      } else if(action==='close'){
        if(confirm('Mark this concern as Closed?')){ concerns[idx].status = 'Closed'; saveConcerns(); renderTable(); updateStats(); }
      }
    });

    // Export CSV
    document.getElementById('export-csv').addEventListener('click', function(){
      const header = ['Date','Barangay','Concern','Status','Response','Sentiment'];
      const rows = concerns.map(r=> [r.date,r.barangay,r.msg,r.status,r.response || '', r.sentiment].map(c=> String(c).includes(',')?`"${String(c).replace(/"/g,'""')}"`:c).join(','))
      const csv = [header.join(','), ...rows].join('\n');
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='concerns.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // Print
    document.getElementById('print-concerns').addEventListener('click', function(){
      const w = window.open('','_blank');
      w.document.write('<html><head><title>Concerns</title><link rel="stylesheet" href="index.css"></head><body>');
      w.document.write('<h2>Concerns</h2>');
      w.document.write(document.querySelector('.table-wrap').innerHTML);
      w.document.write('</body></html>'); w.document.close(); w.focus(); setTimeout(()=>w.print(),300);
    });

    // initial render
    renderTable(); updateStats();
  })();
  </script>

</body>
</html>
